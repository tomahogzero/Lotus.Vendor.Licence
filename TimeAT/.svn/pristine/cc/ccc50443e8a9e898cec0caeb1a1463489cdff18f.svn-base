Imports System.Data
Imports System.Data.SqlClient

Public Class frmVacation

    Dim ar As ArrayList = GetData.GetHourHaftDay

    Private Sub btnExit_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnExit.Click
        Me.Close()
    End Sub

    Public Sub txtCode_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtCode.LostFocus
        Dim DA As New SqlDataAdapter
        Dim DS As New DataSet
        Dim strSQL As String

        strSQL = "Select Code,Fname,Lname,Emp.DeptId,Department,Workingplace" & _
                " From Emp Left Join Department On Emp.DeptId = Department.DeptId " & _
                " Where Code = '" & txtCode.Text.Trim & "'"
        DA = New SqlDataAdapter(strSQL, Conn)
        DA.Fill(DS, "Data")
        With DS.Tables("Data")
            If .Rows.Count = 0 Then
                txtCode.Text = ""
                txtName.Text = ""
                txtDeptId.Text = ""
                txtDepartment.Text = ""
                txtSite.Text = ""
                Exit Sub
            End If
            txtCode.Text = .Rows(0).Item("Code")
            txtName.Text = .Rows(0).Item("Fname") & "   " & .Rows(0).Item("Lname")
            txtDeptId.Text = .Rows(0).Item("DeptId")
            txtDepartment.Text = .Rows(0).Item("Department")
            txtSite.Text = .Rows(0).Item("Workingplace")
            DS.Clear()
        End With

        Call LoadVacation()

        Call LoadValRemain()
    End Sub


    Private Sub LoadVacation()
        Dim Da As New SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String
        ' LoadVacation
    
        Dim arrDATA() As String
        Dim List As New ListViewItem
        If IsNumeric(txtYear.Text.Trim) = False Then txtYear.Text = Now.Year
        strSQL = "Select TimeVacation.Code,Timevacation.Id,ValDate,ValId," & _
                        " TimeWorkingStatus.Description,Amt," & _
                        " Fullday = isnull(TimeVacation.Fullday,'F')," & _
                        " Haftday = isnull(TimeVacation.Haftday,'M'), " & _
                        " Spa_IO = Isnull(TimeVacation.Spa_IO,0) " & _
                " From TimeVacation " & _
                        " Left Join TimeWorkingStatus " & _
                            " On TimeVacation.ValId = TimeWorkingStatus.Code " & _
                " Where TimeVacation.Code = '" & txtCode.Text.Trim & "'"

        If rdYear.Checked = True Then
            strSQL &= " and Year(ValDate) = " & txtYear.Text.Trim & ""
        End If

        strSQL &= " Order By ValDate Desc"

        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "Data")
        With Ds.Tables("Data")
            Dim I As Integer
            lstVacation.Items.Clear()
            For I = 0 To .Rows.Count - 1
                Dim fullday As String = ""
                Dim haftday As String = ""
                Dim Spa_IO As String = ""

                Select Case .Rows(I).Item("Haftday").ToString
                    Case "M"
                        haftday = "ช่วงเช้า"
                    Case "A"
                        haftday = "ช่วงบ่าย"
                End Select

                Select Case .Rows(I).Item("Fullday").ToString
                    Case "F"
                        fullday = "เต็มวัน"
                        haftday = ""
                    Case "H"
                        fullday = "ครึ่งวัน"
                    Case "S"
                        fullday = "ลาพิเศษ"
                End Select

                If .Rows(I).Item("Spa_IO") = True Then
                    Spa_IO = "/"
                Else
                    Spa_IO = ""
                End If

                arrDATA = New String() {I + 1, _
                                        .Rows(I).Item("Id").ToString, _
                                        Format(.Rows(I).Item("ValDate"), "dd/MM/yyyy"), _
                                        .Rows(I).Item("Description"), _
                                        .Rows(I).Item("Amt"), _
                                        fullday.Trim, haftday.Trim, _
                                        Spa_IO}
                List = New ListViewItem(arrDATA)
                lstVacation.Items.Add(List)
            Next
            Ds.Clear()
        End With
    End Sub

    Private Sub txtCode_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtCode.TextChanged

    End Sub

    Private Sub txtDate_GotFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtDate.GotFocus, txtDateST.GotFocus, txtDateSP.GotFocus
        txtDate.SelectAll()
    End Sub

    Private Sub lstVacation_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles lstVacation.DoubleClick
        With lstVacation
            If .SelectedItems.Count = 0 Then Exit Sub
            lblId.Text = .SelectedItems(0).SubItems(1).Text.Trim
            txtDate.Text = .SelectedItems(0).SubItems(2).Text.Trim
            cboWorkingStatus.SelectedItem = .SelectedItems(0).SubItems(3).Text.Trim
            Select Case .SelectedItems(0).SubItems(5).Text.Trim
                Case "เต็มวัน"
                    rdFullDay.Checked = True
                Case "ครึ่งวัน"
                    rdHaftDay.Checked = True
                Case "ลาพิเศษ"
                    rdSpa.Checked = True
                Case Else
                    rdFullDay.Checked = True
            End Select
            Select Case .SelectedItems(0).SubItems(6).Text.Trim
                Case "ช่วงเช้า"
                    rdMorning.Checked = True
                Case "ช่วงบ่าย"
                    rdAfternoon.Checked = True
                Case Else
                    rdMorning.Checked = True
            End Select

            If .SelectedItems(0).SubItems(7).Text.Trim = "/" Then
                rdSpa_IO.Checked = True
            Else
                rdSpa_Between.Checked = True
            End If

            txtAmt.Text = .SelectedItems(0).SubItems(4).Text.Trim
            txtAmt_LostFocus(Me, System.EventArgs.Empty)

            Call EnaCmd(False, True, True)
        End With
    End Sub

    Private Sub lstVacation_ItemChecked(ByVal sender As Object, ByVal e As System.Windows.Forms.ItemCheckedEventArgs) Handles lstVacation.ItemChecked, lstVacation.ItemChecked

    End Sub


    Private Sub btnClear_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnClear.Click
        Call ClearVacation()
        Call LoadVacation()
        txtCode.Focus()
        txtCode.SelectAll()
        Call EnaCmd(True, False, False)
    End Sub

    Private Sub btnAdd_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnAdd.Click
        Dim dCmd As New SqlCommand
        Dim strSQL As String

        Dim Replace As Boolean = False

        If rdByDay.Checked = True Then
            If IsDate(ConvertDate(txtDate.Text.Trim)) = False Then
                MsgBox("กรุณาป้อนวันที่ให้ถูกต้องด้วย", MsgBoxStyle.Information, Me.Text)
                txtDate.Focus()
                txtDate.SelectAll()
                Exit Sub
            End If

            If VacationIsExist(dCmd, txtCode.Text.Trim, ConvertDate(txtDate.Text.Trim.Trim), ConvertDate(txtDate.Text.Trim)) = True Then
                If MsgBox("มีข้อมูลอยู่แล้วคุณต้องการเขียนข้อมูลทับหรือเปล่า", MsgBoxStyle.Information Or MsgBoxStyle.YesNo, Me.Text) = MsgBoxResult.Yes Then
                    Replace = True
                Else
                    Replace = False
                End If
            End If
        Else
            If IsDate(ConvertDate(txtDateST.Text.Trim)) = False Then
                MsgBox("กรุณาป้อนวันที่ให้ถูกต้องด้วย", MsgBoxStyle.Information, Me.Text)
                txtDateST.Focus()
                txtDateST.SelectAll()
                Exit Sub
            End If
            If IsDate(ConvertDate(txtDateSP.Text.Trim)) = False Then
                MsgBox("กรุณาป้อนวันที่ให้ถูกต้องด้วย", MsgBoxStyle.Information, Me.Text)
                txtDateSP.Focus()
                txtDateSP.SelectAll()
                Exit Sub
            End If

            If CDate(ConvertDate(txtDateSP.Text.Trim)) < CDate(ConvertDate(txtDateST.Text.Trim)) Then
                MsgBox("วันสุดท้ายน้อยกว่าวันที่เริ่มต้นกรุณากรอกใหม่", MsgBoxStyle.Information, Me.Text)
                txtDateSP.Focus()
                Exit Sub
            End If

            If VacationIsExist(dCmd, txtCode.Text.Trim, ConvertDate(txtDateST.Text.Trim.Trim), ConvertDate(txtDateSP.Text.Trim)) = True Then
                If MsgBox("มีข้อมูลอยู่ในระหว่างช่วงที่กำหนด คุณต้องการเขียนข้อมูลทับหรือเปล่า", MsgBoxStyle.Information Or MsgBoxStyle.YesNo, Me.Text) = MsgBoxResult.Yes Then
                    Replace = True
                Else
                    Replace = False
                End If
            End If
        End If


        If txtName.Text.Trim = "" Then
            MsgBox("กรุณาป้อนรหัสพนักงานด้วย", MsgBoxStyle.Information, Me.Text)
            txtCode.Focus()
            Exit Sub
        End If

        If lblValCode.Text.Trim = "" Then
            MsgBox("กรุณาเลือกประเภทการลาด้วย", MsgBoxStyle.Information, Me.Text)
            cboWorkingStatus.Focus()
            Exit Sub
        End If


        Dim Tn As SqlTransaction
        Tn = Conn.BeginTransaction
        dCmd.Transaction = Tn
        Try
            Dim Fullday As String = "F"
            Dim Haftday As String = "M"
            If rdFullDay.Checked = True Then
                Fullday = "F"
            ElseIf rdHaftDay.Checked = True Then
                Fullday = "H"
            ElseIf rdSpa.Checked = True Then
                Fullday = "S"
            End If

            If rdMorning.Checked = True Then
                Haftday = "M"
            ElseIf rdAfternoon.Checked = True Then
                Haftday = "A"
            End If

            If rdByDay.Checked = True Then
                If VacationIsExist(dCmd, txtCode.Text.Trim, ConvertDate(txtDate.Text.Trim), ConvertDate(txtDate.Text.Trim)) = True Then
                    If Replace = True Then
                        strSQL = "Delete From TimeVacation" & _
                                " Where Code = '" & txtCode.Text.Trim & "' and " & _
                                        " Convert(nVarchar(10),ValDate,111) = '" & ConvertDate(txtDate.Text.Trim) & "'"
                        dCmd.Connection = Conn
                        dCmd.CommandText = strSQL
                        dCmd.ExecuteNonQuery()

                        strSQL = "Insert Into TimeVacation(Code,ValDate,ValId,Amt,Fullday,Haftday,Spa_IO) Values(" & _
                                    " '" & txtCode.Text.Trim & "'," & _
                                    " '" & ConvertDate(txtDate.Text.Trim) & "'," & _
                                    " '" & lblValCode.Text.Trim & "'," & _
                                    " " & txtAmt.Text.Trim & "," & _
                                    " '" & Fullday.Trim & "','" & Haftday.Trim & "'," & _
                                    " " & IIf(rdSpa_IO.Checked, 1, 0) & ")"
                        dCmd.Connection = Conn
                        dCmd.CommandText = strSQL
                        dCmd.ExecuteNonQuery()
                    End If
                Else
                    strSQL = "Insert Into TimeVacation(Code,ValDate,ValId,Amt,Fullday,Haftday,Spa_IO) Values(" & _
                                    " '" & txtCode.Text.Trim & "'," & _
                                    " '" & ConvertDate(txtDate.Text.Trim) & "'," & _
                                    " '" & lblValCode.Text.Trim & "'," & _
                                    " " & txtAmt.Text.Trim & "," & _
                                    " '" & Fullday.Trim & "','" & Haftday.Trim & "'," & _
                                    " " & IIf(rdSpa_IO.Checked, 1, 0) & ")"
                    dCmd.Connection = Conn
                    dCmd.CommandText = strSQL
                    dCmd.ExecuteNonQuery()
                End If
            Else
                Dim dSt As DateTime = ConvertDate(txtDateST.Text)
                Dim dSp As DateTime = ConvertDate(txtDateSP.Text)
                Dim dR As DateTime = dSt
                Do Until dR > dSp
                    If VacationIsExist(dCmd, txtCode.Text.Trim, dR, dR) = True Then
                        If Replace = True Then
                            strSQL = "Delete From TimeVacation" & _
                                    " Where Code = '" & txtCode.Text.Trim & "' and " & _
                                            " Convert(nVarchar(10),ValDate,111) = '" & Format(dR, "yyyy/MM/dd") & "'"
                            dCmd.Connection = Conn
                            dCmd.CommandText = strSQL
                            dCmd.ExecuteNonQuery()

                            strSQL = "Insert Into TimeVacation(Code,ValDate,ValId,Amt,Fullday,Haftday,Spa_IO) Values(" & _
                                    " '" & txtCode.Text.Trim & "'," & _
                                    " '" & Format(dR, "yyyy/MM/dd") & "'," & _
                                    " '" & lblValCode.Text.Trim & "'," & _
                                    " " & txtAmt.Text.Trim & "," & _
                                    " '" & Fullday.Trim & "','" & Haftday.Trim & "'," & _
                                    " " & IIf(rdSpa_IO.Checked, 1, 0) & ")"
                            dCmd.Connection = Conn
                            dCmd.CommandText = strSQL
                            dCmd.ExecuteNonQuery()
                        End If
                    Else
                        strSQL = "Insert Into TimeVacation(Code,ValDate,ValId,Amt,Fullday,Haftday,Spa_IO) Values(" & _
                                " '" & txtCode.Text.Trim & "'," & _
                                " '" & Format(dR, "yyyy/MM/dd") & "'," & _
                                " '" & lblValCode.Text.Trim & "'," & _
                                " " & txtAmt.Text.Trim & "," & _
                                " '" & Fullday.Trim & "','" & Haftday.Trim & "'," & _
                                " " & IIf(rdSpa_IO.Checked, 1, 0) & ")"
                        dCmd.Connection = Conn
                        dCmd.CommandText = strSQL
                        dCmd.ExecuteNonQuery()
                    End If


                    dR = dR.AddDays(1)
                Loop
            End If
            Tn.Commit()
        Catch ex As Exception
            Tn.Rollback()
            MsgBox(ex.Message, MsgBoxStyle.Critical, Me.Text)
            Exit Sub
        End Try
        Call btnClear_Click(Me, System.EventArgs.Empty)
    End Sub

    Function VacationIsExist(ByVal dCmd As SqlCommand, ByVal Code As String, ByVal DateST As Date, ByVal DateSP As Date) As Boolean
        Dim strSQL As String
        Dim Da As New SqlDataAdapter
        Dim Ds As New DataSet
        strSQL = "Select Code From TimeVacation " & _
                " Where Code = '" & Code.Trim & "' and " & _
                        " Convert(nvarchar(10),ValDate,111) Between '" & Format(DateST, "yyyy/MM/dd") & "' and " & _
                                " '" & Format(DateSP, "yyyy/MM/dd") & "'"
        dCmd.Connection = Conn
        dCmd.CommandText = strSQL
        dCmd.ExecuteNonQuery()
        Da.SelectCommand = dCmd
        Da.Fill(Ds, "data")
        With Ds.Tables("data")
            If .Rows.Count = 0 Then
                Return False
            Else
                Return True
            End If
        End With
    End Function

    Private Sub ClearVacation()
        lblId.Text = ""
        txtDate.Text = ""
        txtDateST.Text = ""
        txtDateSP.Text = ""
        rdFullDay.Checked = True
        rdMorning.Checked = True
        txtDate.Refresh()
    End Sub

    Private Sub frmEditTime_Disposed(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Disposed
        fVacation = Nothing
    End Sub

    Private Sub frmEditTime_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles Me.KeyDown
        If e.KeyCode = Keys.Escape Then
            Me.Close()
        End If
    End Sub

    Private Sub frmEditTime_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles Me.KeyPress
        If Asc(e.KeyChar) = 13 Then
            'If e.KeyChar = Microsoft.VisualBasic.ChrW(Keys.Enter) Then
            If TypeOf Me.ActiveControl Is TextBox Then
                Dim tb As TextBox = DirectCast(Me.ActiveControl, TextBox)
                If tb.Multiline AndAlso tb.AcceptsReturn Then
                    e.Handled = False
                    Exit Sub
                End If
            End If
            e.Handled = True
            Dim oform As Form = Me.FindForm
            oform.SelectNextControl(oform.ActiveControl, True, True, True, True)
            oform.ActiveControl.Focus()
        End If
    End Sub

    Private Sub frmEditTime_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
        txtYear.Text = Date.Now.Year
        Call LoadWorkingStatus()
        Call EnaCmd(True, False, False)
    End Sub

    Private Sub EnaCmd(ByVal Add As Boolean, ByVal Edit As Boolean, ByVal Delete As Boolean)
        btnAdd.Enabled = Add
        btnEdit.Enabled = Edit
        btnDelete.Enabled = Delete
    End Sub

    Private Sub btnEdit_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnEdit.Click
        Dim dCmd As New SqlCommand
        Dim strSQL As String

        If IsDate(ConvertDate(txtDate.Text.Trim)) = False Then
            MsgBox("กรุณาป้อนวันที่ให้ถูกต้องด้วย", MsgBoxStyle.Information, Me.Text)
            txtDate.Focus()
            txtDate.SelectAll()
            Exit Sub
        End If

        If txtName.Text.Trim = "" Then
            MsgBox("กรุณาป้อนรหัสพนักงานด้วย", MsgBoxStyle.Information, Me.Text)
            txtCode.Focus()
            Exit Sub
        End If

        If lblValCode.Text.Trim = "" Then
            MsgBox("กรุณาเลือกประเภทการลาด้วย", MsgBoxStyle.Information, Me.Text)
            cboWorkingStatus.Focus()
            Exit Sub
        End If

        Dim Tn As SqlTransaction
        Tn = Conn.BeginTransaction
        dCmd.Transaction = Tn
        Try
            Dim Fullday As String = "F"
            Dim Haftday As String = "M"
            If rdFullDay.Checked = True Then
                Fullday = "F"
            ElseIf rdHaftDay.Checked = True Then
                Fullday = "H"
            ElseIf rdSpa.Checked = True Then
                Fullday = "S"
            End If

            If rdMorning.Checked = True Then
                Haftday = "M"
            ElseIf rdAfternoon.Checked = True Then
                Haftday = "A"
            End If

            strSQL = "Update TimeVacation Set ValDate = '" & ConvertDate(txtDate.Text.Trim) & "'," & _
                                    " ValId = '" & lblValCode.Text.Trim & "'," & _
                                    " Amt = " & txtAmt.Text.Trim & ", " & _
                                    " Fullday = '" & Fullday.Trim & "'," & _
                                    " haftday = '" & Haftday.Trim & "', " & _
                                    " Spa_IO = " & IIf(rdSpa_IO.Checked, 1, 0) & " " & _
                    " Where Id = '" & lblId.Text.Trim & "'"
            dCmd.Connection = Conn
            dCmd.CommandText = strSQL
            dCmd.ExecuteNonQuery()

            Tn.Commit()
        Catch ex As Exception
            Tn.Rollback()
            MsgBox(ex.Message, MsgBoxStyle.Critical, Me.Text)
            Exit Sub
        End Try
        Call btnClear_Click(Me, System.EventArgs.Empty)
    End Sub

    Private Sub btnDelete_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnDelete.Click
        Dim dCmd As New SqlCommand
        Dim strSQL As String

        If IsDate(ConvertDate(txtDate.Text.Trim)) = False Then
            MsgBox("กรุณาป้อนวันที่ให้ถูกต้องด้วย", MsgBoxStyle.Information, Me.Text)
            txtDate.Focus()
            txtDate.SelectAll()
            Exit Sub
        End If

        If txtName.Text.Trim = "" Then
            MsgBox("กรุณาป้อนรหัสพนักงานด้วย", MsgBoxStyle.Information, Me.Text)
            txtCode.Focus()
            Exit Sub
        End If


        Try
            strSQL = "Delete TimeVacation " & _
              " Where id = '" & lblId.Text.Trim & "'"
            dCmd.Connection = Conn
            dCmd.CommandText = strSQL
            dCmd.ExecuteNonQuery()

        Catch ex As Exception
            MsgBox(ex.Message, MsgBoxStyle.Critical, Me.Text)
            Exit Sub
        End Try
        Call btnClear_Click(Me, System.EventArgs.Empty)
    End Sub

    Private Sub txtTime_GotFocus(ByVal sender As Object, ByVal e As System.EventArgs)

    End Sub

    Private Sub txtTime_MaskInputRejected(ByVal sender As System.Object, ByVal e As System.Windows.Forms.MaskInputRejectedEventArgs)

    End Sub

    Private Sub LoadWorkingStatus()
        Dim Da As New SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String
        strSQL = "Select Code,Description,Pay from TimeWorkingstatus Order By Description"
        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "Data")
        With Ds.Tables("Data")
            cboWorkingStatus.Items.Clear()
            Dim I As Integer
            For I = 0 To .Rows.Count - 1
                cboWorkingStatus.Items.Add(.Rows(I).Item("Description"))
            Next
            Ds.Clear()
        End With
    End Sub

    Private Sub cboWorkingStatus_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cboWorkingStatus.SelectedIndexChanged
        Dim Da As New SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String
        strSQL = "Select Code,Description,Pay " & _
                " from TimeWorkingstatus " & _
                " Where Description = '" & cboWorkingStatus.Text.Trim & "' " & _
                " Order By Description"
        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "Data")
        With Ds.Tables("Data")
            Dim I As Integer
            lblValCode.Text = ""
            For I = 0 To .Rows.Count - 1
                lblValCode.Text = .Rows(I).Item("Code")
                If .Rows(I).Item("Pay") = True Then
                    rdPay.Checked = True
                    'txtAmt.Text = 8
                    'txtAmt.Enabled = False

                    'grpFullDay.Enabled = True
                    'grpHaftDay.Enabled = True
                    'rdSpa.Enabled = True
                Else
                    rdNoPay.Checked = True
                    'txtAmt.Text = 0
                    'txtAmt.Enabled = False

                    'grpFullDay.Enabled = True
                    'grpHaftDay.Enabled = True
                    'rdSpa.Enabled = True
                End If
            Next
            rdFullDay.Checked = True
            rdMorning.Checked = True
            Ds.Clear()
        End With
        Call LoadValRemain()
    End Sub

    Private Sub lstVacation_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lstVacation.SelectedIndexChanged

    End Sub

    Private Sub txtDate_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtDate.LostFocus, txtDateST.LostFocus, txtDateSP.LostFocus
        Call LoadValRemain()
    End Sub

    Private Sub txtDate_MaskInputRejected(ByVal sender As System.Object, ByVal e As System.Windows.Forms.MaskInputRejectedEventArgs) Handles txtDate.MaskInputRejected, txtDateST.MaskInputRejected, txtDateSP.MaskInputRejected

    End Sub

    Private Sub rdPay_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rdPay.CheckedChanged

    End Sub

    Private Sub rdFullDay_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rdFullDay.CheckedChanged
        If rdFullDay.Checked = True And rdPay.Checked = True Then
            txtAmt.Text = 8
            txtDay.Text = 1
        Else
            txtAmt.Text = 8
            txtDay.Text = 1
            'txtAmt.Enabled = False
            'txtDay.Enabled = False
        End If
        txtAmt.Enabled = False
        txtDay.Enabled = False
    End Sub

    Private Sub rdHaftDay_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rdHaftDay.CheckedChanged
        If rdHaftDay.Checked = True Then
            If rdMorning.Checked = True Then
                txtAmt.Text = ar(0)
                txtDay.Text = 0.5
                txtAmt.Enabled = False
            Else
                txtAmt.Text = ar(1)
                txtDay.Text = 0.5
                txtAmt.Enabled = False
            End If
            'Else
            '    If rdMorning.Checked = True Then
            '        txtAmt.Text = ar(0)
            '        txtDay.Text = 0.5
            '    Else
            '        txtAmt.Text = ar(1)
            '        txtDay.Text = 0.5
            '    End If
            txtAmt.Enabled = False
            txtDay.Enabled = False
        End If
    End Sub

    Private Sub txtAmt_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtAmt.LostFocus
        If IsNumeric(txtAmt.Text) = False Then txtDay.Text = 0 : Exit Sub
        If CSng(txtAmt.Text) > 8 Then
            MsgBox("จำนวนชม.ที่ชดเชยไม่ควร 4 ชม.กรุณาตรวจสอบด้วย", MsgBoxStyle.Information, Me.Text)
            Exit Sub
        End If
        txtDay.Text = CSng(txtAmt.Text.Trim) / 8
    End Sub

    Private Sub txtAmt_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtAmt.TextChanged

    End Sub

    Private Sub rdSpa_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rdSpa.CheckedChanged
        txtAmt.Enabled = True
    End Sub

    Private Sub btnRefresh_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnRefresh.Click
        Call LoadVacation()
    End Sub

    Private Sub rdYear_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rdYear.CheckedChanged

    End Sub

    Function GetValcationRemain() As Single
        Dim Da As New SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String

        Dim Year As String
        Dim Code As String
        Dim ValCode As String

        Dim Remain As Single = 0

        If IsDate(ConvertDate(txtDate.Text.Trim)) = False Then
            Return -1
        Else
            Year = CDate(ConvertDate(txtDate.Text.Trim)).Year
        End If

        If txtCode.Text.Trim = "" Then
            Return -1
        Else
            Code = txtCode.Text.Trim
        End If

        If lblValCode.Text.Trim = "" Then
            Return -1
        Else
            ValCode = lblValCode.Text.Trim
        End If
        strSQL = "select Remain = isnull(dbo.fValRemain('" & Year.Trim & "','" & Code.Trim & "','" & ValCode & "'),-1)"
        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "data")
        With Ds.Tables("data")
            If .Rows.Count = 0 Then
                Return -1
            Else
                Return .Rows(0).Item("Remain")
            End If
        End With
    End Function

    Private Sub LoadValRemain()
        Dim Remain As Single = GetValcationRemain()
        If Remain = -1 Then
            txtAmtRemain.Text = "-"
        Else
            txtAmtRemain.Text = Remain
        End If
    End Sub

    Private Sub rdByRange_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rdByRange.CheckedChanged
        If rdByRange.Checked = True Then
            rdFullDay.Checked = True
            rdFullDay.Enabled = False
            rdHaftDay.Enabled = False
            rdSpa.Enabled = False
        End If
    End Sub

    Private Sub rdByDay_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rdByDay.CheckedChanged
        If rdByDay.Checked = True Then
            rdFullDay.Enabled = True
            rdHaftDay.Enabled = True
            rdSpa.Enabled = True
        End If
    End Sub

    Private Sub btnDelete_Sel_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnDelete_Sel.Click
        If MsgBox("คุณต้องการลบข้อมูลที่เลือกไว้จริงๆ หรือไม่", MsgBoxStyle.Information Or MsgBoxStyle.YesNo, Me.Text) = MsgBoxResult.No Then Exit Sub

        Dim dCmd As New SqlCommand
        Dim strSQL As String

        If lstVacation.CheckedItems.Count = 0 Then
            MsgBox("กรุณาเลือกข้อมูลที่ต้องการลบด้วย", MsgBoxStyle.Information, Me.Text)
            Exit Sub
        End If

        Dim Tn As SqlTransaction
        Tn = Conn.BeginTransaction
        dCmd.Transaction = Tn
        Try
            For i As Integer = 0 To lstVacation.CheckedItems.Count - 1
                strSQL = "Delete TimeVacation " & _
                        " Where id = '" & lstVacation.CheckedItems(i).SubItems(1).Text.Trim & "'"
                dCmd.Connection = Conn
                dCmd.CommandText = strSQL
                dCmd.ExecuteNonQuery()
            Next
            Tn.Commit()
        Catch ex As Exception
            Tn.Rollback()
            MsgBox(ex.Message, MsgBoxStyle.Critical, Me.Text)
            Exit Sub
        End Try
        Call btnClear_Click(Me, System.EventArgs.Empty)
    End Sub

    Private Sub rdMorning_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rdMorning.CheckedChanged, rdSpa_IO.CheckedChanged
        Call rdHaftDay_CheckedChanged(Me, System.EventArgs.Empty)
    End Sub

    Private Sub rdAfternoon_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles rdAfternoon.CheckedChanged, rdSpa_Between.CheckedChanged
        Call rdHaftDay_CheckedChanged(Me, System.EventArgs.Empty)
    End Sub
End Class