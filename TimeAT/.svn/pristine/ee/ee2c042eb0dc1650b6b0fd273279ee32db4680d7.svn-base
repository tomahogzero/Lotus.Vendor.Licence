Imports System.Data
Imports System.Data.SqlClient

Public Class frmEmpCalOTConfig

    Private Sub frmEmpCalOT_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
        Call LoadCompany()

        If ComId <> "" Then
            cboCompany.Enabled = False
            cboCompany_Cal.Enabled = False
            cboCompany.SelectedItem = ComName
            cboCompany_Cal.SelectedItem = ComName
        End If

        Call LoadDivision()
        Call LoadDepartment()
        Call LoadPosition()
        Call LoadEmpType()
    End Sub

    Private Sub LoadDepartment()
        Dim Da As SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String = ""
        strSQL = "select Department " & _
                " From Department " & _
                " Order By Department"

        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "data")
        With Ds.Tables("data")
            cboDepartment.Items.Clear()
            cboDepartment.Items.Add("(ทุกแผนก)")

            cboDepartment_Cal.Items.Clear()
            cboDepartment_Cal.Items.Add("(ทุกแผนก)")
            For Each dr As DataRow In .Rows
                cboDepartment.Items.Add(dr("Department"))
                cboDepartment_Cal.Items.Add(dr("Department"))
            Next
            cboDepartment.SelectedIndex = 0
            cboDepartment_Cal.SelectedIndex = 0
        End With
    End Sub

    Private Sub LoadDivision()
        Dim Da As SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String = ""
        strSQL = "select Division " & _
                " From Division " & _
                " Order By Division"

        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "data")
        With Ds.Tables("data")
            cboDivision.Items.Clear()
            cboDivision.Items.Add("(ทุกฝ่าย)")

            cboDivision_Cal.Items.Clear()
            cboDivision_Cal.Items.Add("(ทุกฝ่าย)")
            For Each dr As DataRow In .Rows
                cboDivision.Items.Add(dr("Division"))
                cboDivision_Cal.Items.Add(dr("Division"))
            Next
            cboDivision.SelectedIndex = 0
            cboDivision_Cal.SelectedIndex = 0
        End With
    End Sub

    Private Sub LoadPosition()
        Dim Da As SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String = ""
        strSQL = "select Position " & _
                " From Emp " & _
                " Group By Position " & _
                " Order By Position"

        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "data")
        With Ds.Tables("data")
            cboPosition.Items.Clear()
            cboPosition.Items.Add("(ทุกตำแหน่ง)")

            cboPosition_Cal.Items.Clear()
            cboPosition_Cal.Items.Add("(ทุกตำแหน่ง)")
            For Each dr As DataRow In .Rows
                cboPosition.Items.Add(dr("Position"))
                cboPosition_Cal.Items.Add(dr("Position"))
            Next
            cboPosition.SelectedIndex = 0
            cboPosition_Cal.SelectedIndex = 0
        End With
    End Sub

    Private Sub LoadEmpType()
        Dim Da As SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String = ""
        strSQL = "select TypeName " & _
                " From EmpType " & _
                " Order By TypeName"

        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "data")
        With Ds.Tables("data")
            cboEmpType.Items.Clear()
            cboEmpType.Items.Add("(ทุกประเภท)")

            cboEmpType_Cal.Items.Clear()
            cboEmpType_Cal.Items.Add("(ทุกประเภท)")
            For Each dr As DataRow In .Rows
                cboEmpType.Items.Add(dr("TypeName"))
                cboEmpType_Cal.Items.Add(dr("TypeName"))
            Next
            cboEmpType.SelectedIndex = 0
            cboEmpType_Cal.SelectedIndex = 0
        End With
    End Sub

    Private Sub LoadEmp()
        Dim Da As SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String = ""
        Dim arrData() As String
        Dim List As ListViewItem
        strSQL = "select Emp.Code,Fname,Lname, " & _
                        " Department = Isnull(Department.Department,'') " & _
                " From Emp Left Join Department " & _
                            " On Emp.DeptId = Department.DeptId " & _
                        " Left Join Company_sub cs" & _
                            " on Emp.CompanyID = cs.CompanyID " & _
                        " Left Join EmpConfigOT EOT " & _
                            " on Emp.Code = EOT.EmpCode " & _
                " Where WorkStatus = 'W' and EOT.EmpCode Is null "

        If cboCompany.SelectedIndex > 0 Then
            strSQL &= " and isnull(Emp.CompanyId,'') = '" & GetData.GetCompanyId(cboCompany.Text.Trim) & "'"
        End If

        If cboDivision.SelectedIndex > 0 Then
            strSQL &= " and Isnull(Emp.DivId,'') = '" & GetData.GetDivisionId(cboDivision.Text.Trim) & "'"
        End If

        If cboDepartment.SelectedIndex > 0 Then
            strSQL &= " and Isnull(Emp.DeptId,'') = '" & GetData.GetDepartmentId(cboDepartment.Text.Trim) & "'"
        End If

        If cboPosition.SelectedIndex > 0 Then
            strSQL &= " and Isnull(Emp.Position,'') = '" & cboPosition.Text.Trim & "'"
        End If

        If cboEmpType.SelectedIndex > 0 Then
            strSQL &= " and Isnull(Emp.EmpTypeId,'') = '" & GetData.GetEmpTypeId(cboEmpType.Text.Trim) & "'"
        End If

        If rdMonth.Checked = True Then
            strSQL &= " and Emp.WageType = 'M'"
        End If

        If rdDay.Checked = True Then
            strSQL &= " and Emp.WageType = 'D' and Contractor = 0"
        End If

        If rdContractor.Checked = True Then
            strSQL &= " and Emp.WageType = 'D' and Contractor = 1"
        End If

        If txtNameSearch.Text.Trim <> "" Then
            strSQL &= " and (Fname + LName) Like '%" & Replace(txtNameSearch.Text.Trim, " ", "") & "%'"
        End If

        If rdByCode.Checked = True Then
            strSQL &= " Order By Emp.Code"
        End If

        If rdByName.Checked = True Then
            strSQL &= " Order By Fname,Lname"
        End If

        If rdByDeptCode.Checked = True Then
            strSQL &= " Order By Department.Department,Emp.Code"
        End If

        If rdByDeptName.Checked = True Then
            strSQL &= " Order By Department.Department,Fname,Lname"
        End If

        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "data")
        With Ds.Tables("data")
            'lstEmp.BeginUpdate()
            If .Rows.Count = 0 Then
                lstEmp.Items.Clear()
            Else
                lstEmp.Items.Clear()
                For Each dr As DataRow In .Rows
                    arrData = New String() {lstEmp.Items.Count + 1, _
                                            dr("Code"), _
                                            dr("Fname"), _
                                            dr("LName"), _
                                            dr("Department")}
                    List = New ListViewItem(arrData)
                    lstEmp.Items.Add(List)
                Next
            End If
            'lstEmp.EndUpdate()
        End With
    End Sub

    Private Sub LoadEmpKaDate()
        Dim Da As SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String = ""
        Dim arrData() As String
        Dim List As ListViewItem
        strSQL = "select Code,Fname,Lname, " & _
                        " Department = Isnull(Department.Department,'') " & _
                " From Emp Left Join Department " & _
                        " On Emp.DeptId = Department.DeptId " & _
                             " Left Join Company_sub cs" & _
                        " on Emp.CompanyID = cs.CompanyID " & _
                " Where WorkStatus = 'W' and Isnull(UseKaDate,0) = 1"

        If cboDepartment_Cal.SelectedIndex > 0 Then
            strSQL &= " and Isnull(Department.Department,'') = '" & cboDepartment_Cal.Text.Trim & "'"
        End If

        If txtNameSearch_Cal.Text.Trim <> "" Then
            strSQL &= " and (Fname + LName) Like '%" & Replace(txtNameSearch_Cal.Text.Trim, " ", "") & "%'"
        End If

        If cboCompany_Cal.SelectedIndex > 0 Then
            strSQL &= " and isnull(cs.CompanyName,'') = '" & cboCompany_Cal.Text.Trim & "'"
        End If



        If rdByCode_Date.Checked = True Then
            strSQL &= " Order By Code"
        End If

        If rdByName_Date.Checked = True Then
            strSQL &= " Order By Fname,Lname"
        End If

        If rdByDeptCode_Date.Checked = True Then
            strSQL &= " Order By Department.Department,Code"
        End If

        If rdByDeptName_Date.Checked = True Then
            strSQL &= " Order By Department.Department,Fname,Lname"
        End If

        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "data")
        With Ds.Tables("data")
            'lstEmp.BeginUpdate()
            If .Rows.Count = 0 Then
                lstEmp_Cal.Items.Clear()
            Else
                lstEmp_Cal.Items.Clear()
                For Each dr As DataRow In .Rows
                    arrData = New String() {lstEmp_Cal.Items.Count + 1, _
                                            dr("Code"), _
                                            dr("Fname"), _
                                            dr("LName"), _
                                            dr("Department")}
                    List = New ListViewItem(arrData)
                    lstEmp_Cal.Items.Add(List)
                Next
            End If
            'lstEmp.EndUpdate()
        End With
    End Sub

    Private Sub btnRefresh_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnRefresh.Click
        Call LoadEmp()
    End Sub

    Private Sub btnRefresh_Date_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnRefresh_Cal.Click
        Call LoadEmpKaDate()
    End Sub

    Private Sub btnSelectAll_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSelectAll.Click
        With lstEmp
            For i As Integer = 0 To .Items.Count - 1
                .Items(i).Checked = True
            Next
        End With
    End Sub

    Private Sub btnNoneSelectAll_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnNoneSelectAll.Click
        With lstEmp
            For i As Integer = 0 To .Items.Count - 1
                .Items(i).Checked = False
            Next
        End With
    End Sub

    Private Sub btnNoneSelectAll_Date_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnNoneSelectAll_Date.Click
        With lstEmp_Cal
            For i As Integer = 0 To .Items.Count - 1
                .Items(i).Checked = False
            Next
        End With
    End Sub

    Private Sub btnSelectAll_Date_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSelectAll_Date.Click
        With lstEmp_Cal
            For i As Integer = 0 To .Items.Count - 1
                .Items(i).Checked = True
            Next
        End With
    End Sub

    Private Sub btnAdd_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnAdd.Click
        If lstEmp.CheckedItems.Count = 0 Then Exit Sub
        Dim dCmd As New SqlCommand
        Dim strSQL As String
        Dim Tn As SqlTransaction

        Tn = Conn.BeginTransaction
        dCmd.Transaction = Tn
        Try
            For i As Integer = 0 To lstEmp.CheckedItems.Count - 1
                strSQL = "Update Emp Set OT = 1 " & _
                        " Where Code = '" & lstEmp.CheckedItems(i).SubItems(1).Text.Trim & "'"
                dCmd.Connection = Conn
                dCmd.CommandText = strSQL
                dCmd.ExecuteNonQuery()
            Next
            Tn.Commit()
        Catch ex As Exception
            Tn.Rollback()
            MsgBox(ex.Message, MsgBoxStyle.Information, Me.Text)
            Exit Sub
        End Try
        Call btnRefresh_Click(Me, System.EventArgs.Empty)
        Call btnRefresh_Date_Click(Me, System.EventArgs.Empty)
    End Sub

    Private Sub btnRemove_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnRemove.Click
        If lstEmp_Cal.CheckedItems.Count = 0 Then Exit Sub
        Dim dCmd As New SqlCommand
        Dim strSQL As String
        Dim Tn As SqlTransaction

        Tn = Conn.BeginTransaction
        dCmd.Transaction = Tn
        Try
            For i As Integer = 0 To lstEmp_Cal.CheckedItems.Count - 1
                strSQL = "Update Emp Set OT = 0 " & _
                        " Where Code = '" & lstEmp_Cal.CheckedItems(i).SubItems(1).Text.Trim & "'"
                dCmd.Connection = Conn
                dCmd.CommandText = strSQL
                dCmd.ExecuteNonQuery()
            Next
            Tn.Commit()
        Catch ex As Exception
            Tn.Rollback()
            MsgBox(ex.Message, MsgBoxStyle.Information, Me.Text)
            Exit Sub
        End Try
        Call btnRefresh_Click(Me, System.EventArgs.Empty)
        Call btnRefresh_Date_Click(Me, System.EventArgs.Empty)
    End Sub

    Private Sub btnExit_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnExit.Click
        Me.Close()
    End Sub

    Private Sub LoadCompany()
        Dim Da As New SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String
        strSQL = "Select CompanyName From Company_Sub "
        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "Data")
        With Ds.Tables("Data")
            cboCompany.Items.Clear()
            cboCompany.Items.Add("ทั้งหมด")

            cboCompany_Cal.Items.Clear()
            cboCompany_Cal.Items.Add("ทั้งหมด")

            Dim I As Integer
            For I = 0 To .Rows.Count - 1
                cboCompany.Items.Add(.Rows(I).Item("CompanyName"))

                cboCompany_Cal.Items.Add(.Rows(I).Item("CompanyName"))
            Next
            Ds.Clear()
            cboCompany.SelectedIndex = 0
            cboCompany_Cal.SelectedIndex = 0
        End With
    End Sub

End Class