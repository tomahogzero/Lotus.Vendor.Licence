Imports System.Data
Imports System.Data.SqlClient

Public Class frmPrivilegeVal

    Private Sub btnExit_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnExit.Click
        Me.Close()
    End Sub

    Public Sub txtCode_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtCode.LostFocus
        Dim DA As New SqlDataAdapter
        Dim DS As New DataSet
        Dim strSQL As String

        strSQL = "Select Code,Fname,Lname,Emp.DeptId,Department,Workingplace" & _
                " From Emp Left Join Department On Emp.DeptId = Department.DeptId " & _
                " Where Code = '" & txtCode.Text.Trim & "' and " & _
                    " Emp.CompanyId like '" & IIf(ComId.Trim = "", "%", ComId.Trim) & "' "

        DA = New SqlDataAdapter(strSQL, Conn)
        DA.Fill(DS, "Data")
        With DS.Tables("Data")
            If .Rows.Count = 0 Then
                txtCode.Text = ""
                txtName.Text = ""
                txtDeptId.Text = ""
                txtDepartment.Text = ""
                txtSite.Text = ""
                Exit Sub
            End If
            txtCode.Text = .Rows(0).Item("Code")
            txtName.Text = .Rows(0).Item("Fname") & "   " & .Rows(0).Item("Lname")
            txtDeptId.Text = .Rows(0).Item("DeptId")
            txtDepartment.Text = .Rows(0).Item("Department")
            txtSite.Text = .Rows(0).Item("Workingplace")
            DS.Clear()
        End With
    End Sub


    Private Sub LoadVacation()
        Dim Da As New SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String
        ' LoadVacation

        Dim arrDATA() As String
        Dim List As New ListViewItem

        strSQL = "Select Pri.Id,Pri.Year,Pri.Code," & _
                        " Title = Isnull(Emp.Title,'')," & _
                        " FName = Isnull(Emp.Fname,'')," & _
                        " LName = Isnull(Emp.LName,'')," & _
                        " Pri.ValCode," & _
                        " Description = Isnull(TimeWorkingStatus.Description,'')," & _
                        " Amt = Isnull(Amt,0), " & _
                        " AmtUse = isnull((select Sum(Amt)/8 " & _
                                    " from TimeVacation " & _
                                    " where year(ValDate) = '" & txtYearly.Text.Trim & "' and " & _
                                    " Code = Pri.Code and ValId = Pri.ValCode),0)" & _
                " From TimePrivilege_Val Pri " & _
                        " Left Join Emp " & _
                            " On Pri.Code = Emp.Code " & _
                        " Left Join TimeWorkingStatus " & _
                            " On Pri.ValCode = TimeWorkingStatus.Code " & _
                " Where Pri.Year = '" & txtYearly.Text.Trim & "' and " & _
                        " Emp.CompanyID like '" & IIf(ComId.Trim = "", "%", ComId.Trim) & "' "

        strSQL &= " Order By Pri.Code Desc"

        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "Data")
        With Ds.Tables("Data")
            Dim I As Integer
            lstVacation.Items.Clear()
            For I = 0 To .Rows.Count - 1
                Dim dr As DataRow = .Rows(I)
                arrDATA = New String() {I + 1, _
                                        dr("Id").ToString, _
                                        dr("Code"), _
                                        dr("Title") & dr("Fname"), _
                                        dr("Lname"), _
                                        dr("Description"), _
                                        Format(dr("Amt"), "#0.00"), _
                                        Format(dr("AmtUse"), "#0.00"), _
                                        Format(dr("Amt") - dr("AmtUse"), "#0.00")}
                List = New ListViewItem(arrDATA)
                lstVacation.Items.Add(List)
            Next
            Ds.Clear()
        End With
    End Sub

    Private Sub txtCode_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtCode.TextChanged

    End Sub

    Private Sub lstVacation_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles lstVacation.DoubleClick
        With lstVacation
            If .SelectedItems.Count = 0 Then Exit Sub
            lblId.Text = .SelectedItems(0).SubItems(1).Text.Trim
            txtCode.Text = .SelectedItems(0).SubItems(2).Text.Trim
            cboWorkingStatus.SelectedItem = .SelectedItems(0).SubItems(5).Text.Trim
            txtAmt.Text = .SelectedItems(0).SubItems(6).Text.Trim
            txtCode_LostFocus(Me, System.EventArgs.Empty)
            Call EnaCmd(False, True, True)
        End With
    End Sub

    Private Sub lstVacation_ItemChecked(ByVal sender As Object, ByVal e As System.Windows.Forms.ItemCheckedEventArgs) Handles lstVacation.ItemChecked, lstVacation.ItemChecked

    End Sub


    Private Sub btnClear_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnClear.Click
        Call ClearVacation()
        Call LoadVacation()
        txtCode.Focus()
        txtCode.SelectAll()
        Call EnaCmd(True, False, False)
    End Sub

    Private Sub btnAdd_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnAdd.Click
        Dim dCmd As New SqlCommand
        Dim strSQL As String

        If txtYearly.Text.Trim = "" Then
            MsgBox("กรุณาป้อนปีด้วย", MsgBoxStyle.Information, Me.Text)
            txtYearly.Focus()
            Exit Sub
        End If

        If IsNumeric(txtYearly.Text.Trim) = False Then
            MsgBox("กรุณาป้อนปีเป็นตัวเลขให้ถูกต้องด้วย", MsgBoxStyle.Information, Me.Text)
            txtYearly.Focus()
            Exit Sub
        End If

        If txtName.Text.Trim = "" Then
            MsgBox("กรุณาป้อนรหัสพนักงานด้วย", MsgBoxStyle.Information, Me.Text)
            txtCode.Focus()
            Exit Sub
        End If

        If lblValCode.Text.Trim = "" Then
            MsgBox("กรุณาเลือกประเภทการลาด้วย", MsgBoxStyle.Information, Me.Text)
            cboWorkingStatus.Focus()
            Exit Sub
        End If

        If IsNumeric(txtAmt.Text.Trim) = False Then
            MsgBox("กรุณาป้อนตัวเลขให้ถูกต้องด้วย", MsgBoxStyle.Information, Me.Text)
            txtAmt.Focus()
            Exit Sub
        End If


        Try
            strSQL = "Insert Into TimePrivilege_Val(Year,Code,ValCode,Amt) Values(" & _
                    " '" & txtYearly.Text.Trim & "'," & _
                    " '" & txtCode.Text.Trim & "'," & _
                    " '" & lblValCode.Text.Trim & "'," & _
                    " " & txtAmt.Text.Trim & ")"
            dCmd.Connection = Conn
            dCmd.CommandText = strSQL
            dCmd.ExecuteNonQuery()
        Catch ex As Exception
            MsgBox(ex.Message, MsgBoxStyle.Critical, Me.Text)
            Exit Sub
        End Try
        Call btnClear_Click(Me, System.EventArgs.Empty)
    End Sub

    Private Sub ClearVacation()
        lblId.Text = ""
        txtCode.Text = ""
        Call txtCode_LostFocus(Me, System.EventArgs.Empty)
        txtAmt.Text = ""
    End Sub

    Private Sub frmEditTime_Disposed(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Disposed
        fVacation = Nothing
    End Sub

    Private Sub frmEditTime_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles Me.KeyDown
        If e.KeyCode = Keys.Escape Then
            Me.Close()
        End If
    End Sub

    Private Sub frmEditTime_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles Me.KeyPress
        If Asc(e.KeyChar) = 13 Then
            'If e.KeyChar = Microsoft.VisualBasic.ChrW(Keys.Enter) Then
            If TypeOf Me.ActiveControl Is TextBox Then
                Dim tb As TextBox = DirectCast(Me.ActiveControl, TextBox)
                If tb.Multiline AndAlso tb.AcceptsReturn Then
                    e.Handled = False
                    Exit Sub
                End If
            End If
            e.Handled = True
            Dim oform As Form = Me.FindForm
            oform.SelectNextControl(oform.ActiveControl, True, True, True, True)
            oform.ActiveControl.Focus()
        End If
    End Sub

    Private Sub frmPrivilegeVal_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
        txtYearly.Text = Date.Now.Year
        Call LoadWorkingStatus()
        Call LoadVacation()
        Call EnaCmd(True, False, False)
    End Sub

    Private Sub EnaCmd(ByVal Add As Boolean, ByVal Edit As Boolean, ByVal Delete As Boolean)
        btnAdd.Enabled = Add
        btnEdit.Enabled = Edit
        btnDelete.Enabled = Delete
    End Sub

    Private Sub btnEdit_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnEdit.Click
        Dim dCmd As New SqlCommand
        Dim strSQL As String

        If txtYearly.Text.Trim = "" Then
            MsgBox("กรุณาป้อนปีด้วย", MsgBoxStyle.Information, Me.Text)
            txtYearly.Focus()
            Exit Sub
        End If

        If IsNumeric(txtYearly.Text.Trim) = False Then
            MsgBox("กรุณาป้อนปีเป็นตัวเลขให้ถูกต้องด้วย", MsgBoxStyle.Information, Me.Text)
            txtYearly.Focus()
            Exit Sub
        End If

        If txtName.Text.Trim = "" Then
            MsgBox("กรุณาป้อนรหัสพนักงานด้วย", MsgBoxStyle.Information, Me.Text)
            txtCode.Focus()
            Exit Sub
        End If

        If lblValCode.Text.Trim = "" Then
            MsgBox("กรุณาเลือกประเภทการลาด้วย", MsgBoxStyle.Information, Me.Text)
            cboWorkingStatus.Focus()
            Exit Sub
        End If

        If IsNumeric(txtAmt.Text.Trim) = False Then
            MsgBox("กรุณาป้อนตัวเลขให้ถูกต้องด้วย", MsgBoxStyle.Information, Me.Text)
            txtAmt.Focus()
            Exit Sub
        End If


        Try
            strSQL = "Update TimePrivilege_Val Set " & _
                                " Year = '" & txtYearly.Text.Trim & "'," & _
                                " Code = '" & txtCode.Text.Trim & "'," & _
                                " ValCode = '" & lblValCode.Text.Trim & "'," & _
                                " Amt = " & txtAmt.Text & _
                    " Where ID = " & lblId.Text
            dCmd.Connection = Conn
            dCmd.CommandText = strSQL
            dCmd.ExecuteNonQuery()
        Catch ex As Exception
            MsgBox(ex.Message, MsgBoxStyle.Critical, Me.Text)
            Exit Sub
        End Try
        Call btnClear_Click(Me, System.EventArgs.Empty)
    End Sub

    Private Sub btnDelete_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnDelete.Click
        Dim dCmd As New SqlCommand
        Dim strSQL As String

        If txtName.Text.Trim = "" Then
            MsgBox("กรุณาป้อนรหัสพนักงานด้วย", MsgBoxStyle.Information, Me.Text)
            txtCode.Focus()
            Exit Sub
        End If

        Try
            strSQL = "Delete From TimePrivilege_Val " & _
              " Where id = " & lblId.Text.Trim
            dCmd.Connection = Conn
            dCmd.CommandText = strSQL
            dCmd.ExecuteNonQuery()

        Catch ex As Exception
            MsgBox(ex.Message, MsgBoxStyle.Critical, Me.Text)
            Exit Sub
        End Try
        Call btnClear_Click(Me, System.EventArgs.Empty)
    End Sub

    Private Sub txtTime_GotFocus(ByVal sender As Object, ByVal e As System.EventArgs)

    End Sub

    Private Sub txtTime_MaskInputRejected(ByVal sender As System.Object, ByVal e As System.Windows.Forms.MaskInputRejectedEventArgs)

    End Sub

    Private Sub LoadWorkingStatus()
        Dim Da As New SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String
        strSQL = "Select Code,Description,Pay from TimeWorkingstatus Order By Description"
        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "Data")
        With Ds.Tables("Data")
            cboWorkingStatus.Items.Clear()
            Dim I As Integer
            For I = 0 To .Rows.Count - 1
                cboWorkingStatus.Items.Add(.Rows(I).Item("Description"))
            Next
            Ds.Clear()
        End With
    End Sub

    Private Sub cboWorkingStatus_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cboWorkingStatus.SelectedIndexChanged
        Dim Da As New SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String
        strSQL = "Select Code,Description,Pay " & _
                " from TimeWorkingstatus " & _
                " Where Description = '" & cboWorkingStatus.Text.Trim & "' " & _
                " Order By Description"
        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "Data")
        With Ds.Tables("Data")
            Dim I As Integer
            lblValCode.Text = ""
            For I = 0 To .Rows.Count - 1
                lblValCode.Text = .Rows(I).Item("Code")
            Next
            Ds.Clear()
        End With
    End Sub

    Private Sub lstVacation_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lstVacation.SelectedIndexChanged

    End Sub

    Private Sub txtDate_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs)

    End Sub

    Private Sub txtDate_MaskInputRejected(ByVal sender As System.Object, ByVal e As System.Windows.Forms.MaskInputRejectedEventArgs)

    End Sub

    Private Sub rdPay_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)

    End Sub

    Private Sub txtAmt_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)

    End Sub

    Private Sub rdSpa_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)
        txtAmt.Enabled = True
    End Sub

    Private Sub btnRefresh_Click(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call LoadVacation()
    End Sub

    Private Sub rdYear_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs)

    End Sub

    Private Sub txtSite_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtSite.TextChanged

    End Sub

    Private Sub txtDepartment_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtDepartment.TextChanged

    End Sub

    Private Sub GroupBox4_Enter(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles GroupBox4.Enter

    End Sub
End Class