Imports System.Data
Imports System.Data.SqlClient

Public Class frmEditTime

    Enum TimeIO
        Time_IN
        Time_OUT
    End Enum

    Private Sub btnExit_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnExit.Click
        Me.Close()
    End Sub

    Public Sub txtCode_LostFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtCode.LostFocus
        Dim DA As New SqlDataAdapter
        Dim DS As New DataSet
        Dim strSQL As String
        strSQL = "Select Code,Fname,Lname," & _
                        " DeptID = Isnull(Emp.DeptId,'')," & _
                        " Department = Isnull(Department,'')," & _
                        " Workingplace = Isnull(Workingplace,'')" & _
                " From Emp Left Join Department On Emp.DeptId = Department.DeptId " & _
                " Where Code = '" & txtCode.Text.Trim & "' and " & _
                        " Emp.CompanyID like '" & IIf(ComId.Trim = "", "%", ComId.Trim) & "' "
        DA = New SqlDataAdapter(strSQL, Conn)
        DA.Fill(DS, "Data")
        With DS.Tables("Data")
            If .Rows.Count = 0 Then
                txtCode.Text = ""
                txtName.Text = ""
                txtDeptId.Text = ""
                txtDepartment.Text = ""
                txtSite.Text = ""
                lstTimeEdit.Items.Clear()
                Exit Sub
            End If
            txtCode.Text = .Rows(0).Item("Code")
            txtName.Text = .Rows(0).Item("Fname") & "   " & .Rows(0).Item("Lname")
            txtDeptId.Text = .Rows(0).Item("DeptId")
            txtDepartment.Text = .Rows(0).Item("Department")
            txtSite.Text = .Rows(0).Item("Workingplace")
            DS.Clear()
        End With

        Call LoadEmpKa(txtCode.Text.Trim, ConvertDate(txtDate.Text.Trim))
        Call LoadTime()
    End Sub

    Private Sub LoadEmpKa(ByVal Code As String, ByVal strDate As String)
        Dim KaCode As String

        Dim Da As New SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String
        strSQL = "Select KaCode = Isnull(dbo.fGetKaCode_Edit('" & Code.Trim & "','" & strDate.Trim & "'),'')"
        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "data")
        With Ds.Tables("data")
            If .Rows.Count = 0 Then
                KaCode = ""
            Else
                KaCode = .Rows(0).Item("KaCode")
            End If
        End With
        Call LoadKa(KaCode)
    End Sub


    Private Sub LoadTime()
        Dim Da As New SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String
        ' LoadTime
        If IsDate(ConvertDate(txtDate.Text.Trim)) = False Then
            Exit Sub
        End If

        Dim arrDATA() As String
        Dim List As New ListViewItem

        Dim DateST As String = GetKaScope(lblKaCode.Text.Trim, ConvertDate(txtDate.Text.Trim), TimeIO.Time_IN)
        Dim DateSP As String = GetKaScope(lblKaCode.Text.Trim, ConvertDate(txtDate.Text.Trim), TimeIO.Time_OUT)

        strSQL = "Select Id,Code," & _
                        " [tmDate] = Convert(nVarchar(10),DateIn,111)," & _
                        " [tmTime] = Right(Convert(nVarchar(16),DateIn,120),5) " & _
                " From TimeMaster " & _
                " Where Code = '" & txtCode.Text.Trim & "' and " & _
                        " Replace(Convert(nVarchar(16),DateIn,120),'-','/') Between '" & DateST.Trim & "' and '" & DateSP.Trim & "'" & _
                " Order By DateIn"
        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "Data")
        With Ds.Tables("Data")
            Dim I As Integer
            lstTimeEdit.Items.Clear()
            For I = 0 To .Rows.Count - 1
                arrDATA = New String() {I + 1, _
                                        .Rows(I).Item("ID").ToString, _
                                        ConvertDate(.Rows(I).Item("tmDate")), _
                                        .Rows(I).Item("tmTime")}
                List = New ListViewItem(arrDATA)
                lstTimeEdit.Items.Add(List)
            Next
            Ds.Clear()
        End With
    End Sub

    Private Sub txtCode_TextChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txtCode.TextChanged

    End Sub

    Private Sub txtDate_GotFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtDate.GotFocus
        txtDate.SelectAll()
    End Sub

    Private Sub lstTimeEdit_ItemChecked(ByVal sender As Object, ByVal e As System.Windows.Forms.ItemCheckedEventArgs) Handles lstTimeEdit.ItemChecked

    End Sub

    Private Sub lstTimeEdit_SelectedIndexChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles lstTimeEdit.SelectedIndexChanged
        With lstTimeEdit
            If .SelectedItems.Count = 0 Then Exit Sub
            txtTime.Text = .SelectedItems(0).SubItems(3).Text.Trim
            If CDate(ConvertDate(txtDate.Text)) = CDate(ConvertDate(.SelectedItems(0).SubItems(2).Text.Trim)) Then
                chkNextDay.Checked = False
                chkPreviousDay.Checked = False
            ElseIf CDate(ConvertDate(txtDate.Text)) < CDate(ConvertDate(.SelectedItems(0).SubItems(2).Text.Trim)) Then
                chkNextDay.Checked = True
                chkPreviousDay.Checked = False
            ElseIf CDate(ConvertDate(txtDate.Text)) > CDate(ConvertDate(.SelectedItems(0).SubItems(2).Text.Trim)) Then
                chkNextDay.Checked = False
                chkPreviousDay.Checked = True
            End If
            lblId.Text = .SelectedItems(0).SubItems(1).Text.Trim
        End With
        Call EnaCmd(False, True, True)
    End Sub

    Private Sub btnClear_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnClear.Click
        Call ClearTime()
        Call LoadTime()
        txtTime.Focus()
        Call EnaCmd(True, False, False)
    End Sub

    Private Sub btnAdd_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnAdd.Click
        Dim dCmd As New SqlCommand
        Dim strSQL As String

        If IsDate(ConvertDate(txtDate.Text.Trim)) = False Then
            MsgBox("กรุณาป้อนวันที่ให้ถูกต้องด้วย", MsgBoxStyle.Information, Me.Text)
            txtDate.Focus()
            txtDate.SelectAll()
            Exit Sub
        End If

        If txtName.Text.Trim = "" Then
            MsgBox("กรุณาป้อนรหัสพนักงานด้วย", MsgBoxStyle.Information, Me.Text)
            txtCode.Focus()
            Exit Sub
        End If

        If IsDate("2007/01/01 " & txtTime.Text.Trim) = False Then
            MsgBox("กรุณาป้อนเวลาให้ถูกต้องด้วย", MsgBoxStyle.Information, Me.Text)
            txtTime.Focus()
            Exit Sub
        End If
        If chkNextDay.Checked = True And chkPreviousDay.Checked = True Then
            MsgBox("กรุณาเลือกว่าจะเอา วันถัดไป หรือ จะเอาวันก่อนหน้า ให้เลือกอย่างใดอย่างหนึ่ง", MsgBoxStyle.Information, Me.Text)
            chkNextDay.Focus()
            Exit Sub
        End If

        Dim NewTime As String
        NewTime = GetCurDay(txtCode.Text.Trim, ConvertDate(txtDate.Text.Trim), txtTime.Text.Trim)
        'If chkNextDay.Checked = True Then
        '    NewTime = Format(DateAdd(DateInterval.Day, 1, CDate(NewTime)), "yyyy/MM/dd")
        'End If
        'If chkPreviousDay.Checked = True Then
        '    NewTime = Format(DateAdd(DateInterval.Day, -1, CDate(NewTime)), "yyyy/MM/dd")
        'End If
        NewTime = NewTime & " " & txtTime.Text.Trim

        Try
            strSQL = "Insert Into TimeMaster(Code,DateIn,SystemGet) Values(" & _
                    " '" & txtCode.Text.Trim & "'," & _
                    " '" & NewTime.Trim & "'," & _
                    " 'E')"
            dCmd.Connection = Conn
            dCmd.CommandText = strSQL
            dCmd.ExecuteNonQuery()
        Catch ex As Exception
            MsgBox(ex.Message, MsgBoxStyle.Critical, Me.Text)
            Exit Sub
        End Try
        Call GenTimework()
        Call btnClear_Click(Me, System.EventArgs.Empty)
    End Sub

    Function GetCurDay(ByVal Code As String, ByVal strDate As String, ByVal strTime As String) As String
        Dim Da As New SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String
        strSQL = "Select curDate = isnull(dbo.fCurDay('" & Code.Trim & "','" & strDate & "','" & strTime.Trim & "'),'')"
        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "data")
        With Ds.Tables("data")
            If .Rows.Count = 0 Then
                Return strDate
            Else
                Return .Rows(0).Item("curDate")
            End If
        End With
    End Function

    Private Sub ClearTime()
        lblId.Text = ""
        txtTime.Text = ""
        chkNextDay.Checked = False
        chkPreviousDay.Checked = False
    End Sub

    Private Sub frmEditTime_Disposed(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Disposed
        fEditTime = Nothing
    End Sub

    Private Sub frmEditTime_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles Me.KeyDown
        If e.KeyCode = Keys.Escape Then
            Me.Close()
        End If
    End Sub

    Private Sub frmEditTime_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles Me.KeyPress
        If Asc(e.KeyChar) = 13 Then
            'If e.KeyChar = Microsoft.VisualBasic.ChrW(Keys.Enter) Then
            If TypeOf Me.ActiveControl Is TextBox Then
                Dim tb As TextBox = DirectCast(Me.ActiveControl, TextBox)
                If tb.Multiline AndAlso tb.AcceptsReturn Then
                    e.Handled = False
                    Exit Sub
                End If
            End If
            e.Handled = True
            Dim oform As Form = Me.FindForm
            oform.SelectNextControl(oform.ActiveControl, True, True, True, True)
            oform.ActiveControl.Focus()
        End If
    End Sub

    Private Sub ReadMenuManageTime_ReadOnly()  ' เมนูประมวลผลเวลาทำงาน
        fEditTime.btnAdd.Enabled = setPermission.ManageTime_ReadOnly
        fEditTime.btnAdd.Enabled = setPermission.ManageTime_ReadOnly


    End Sub



    Private Sub frmEditTime_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
        Call EnaCmd(True, False, False)

    End Sub

    Private Sub EnaCmd(ByVal Add As Boolean, ByVal Edit As Boolean, ByVal Delete As Boolean)
        If setPermission.ManageTime_ReadOnly = True Then  ' ปกติให้ดูได้
            btnAdd.Enabled = Add
            btnEdit.Enabled = Edit
            btnDelete.Enabled = Delete

        Else ' มีเงือนไข ให้ ReadOnly
            btnAdd.Enabled = False
            btnEdit.Enabled = False
            btnDelete.Enabled = False
            btnClear.Enabled = False
        End If


    End Sub

    Private Sub btnEdit_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnEdit.Click
        Dim dCmd As New SqlCommand
        Dim strSQL As String

        If IsDate(ConvertDate(txtDate.Text.Trim)) = False Then
            MsgBox("กรุณาป้อนวันที่ให้ถูกต้องด้วย", MsgBoxStyle.Information, Me.Text)
            txtDate.Focus()
            txtDate.SelectAll()
            Exit Sub
        End If

        If txtName.Text.Trim = "" Then
            MsgBox("กรุณาป้อนรหัสพนักงานด้วย", MsgBoxStyle.Information, Me.Text)
            txtCode.Focus()
            Exit Sub
        End If

        If IsDate("2007/01/01 " & txtTime.Text.Trim) = False Then
            MsgBox("กรุณาป้อนเวลาให้ถูกต้องด้วย", MsgBoxStyle.Information, Me.Text)
            txtTime.Focus()
            Exit Sub
        End If
        If chkNextDay.Checked = True And chkPreviousDay.Checked = True Then
            MsgBox("กรุณาเลือกว่าจะเอา วันถัดไป หรือ จะเอาวันก่อนหน้า ให้เลือกอย่างใดอย่างหนึ่ง", MsgBoxStyle.Information, Me.Text)
            chkNextDay.Focus()
            Exit Sub
        End If

        Dim NewTime As String
        'NewTime = ConvertDate(txtDate.Text)
        NewTime = GetCurDay(txtCode.Text.Trim, ConvertDate(txtDate.Text.Trim), txtTime.Text.Trim)
        'If chkNextDay.Checked = True Then
        '    NewTime = Format(DateAdd(DateInterval.Day, 1, CDate(NewTime)), "yyyy/MM/dd")
        'End If
        'If chkPreviousDay.Checked = True Then
        '    NewTime = Format(DateAdd(DateInterval.Day, -1, CDate(NewTime)), "yyyy/MM/dd")
        'End If
        NewTime = NewTime & " " & txtTime.Text.Trim


        Try
            strSQL = "Update TimeMaster Set " & _
                            " DateIn = '" & NewTime.Trim & "'," & _
                            " SystemGet = 'E'" & _
                    " Where Id = '" & lblId.Text.Trim & "'"
            dCmd.Connection = Conn
            dCmd.CommandText = strSQL
            dCmd.ExecuteNonQuery()
        Catch ex As Exception
            MsgBox(ex.Message, MsgBoxStyle.Critical, Me.Text)
            Exit Sub
        End Try
        Call GenTimework()
        Call btnClear_Click(Me, System.EventArgs.Empty)
    End Sub

    Private Sub btnDelete_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnDelete.Click
        Dim dCmd As New SqlCommand
        Dim strSQL As String

        If IsDate(ConvertDate(txtDate.Text.Trim)) = False Then
            MsgBox("กรุณาป้อนวันที่ให้ถูกต้องด้วย", MsgBoxStyle.Information, Me.Text)
            txtDate.Focus()
            txtDate.SelectAll()
            Exit Sub
        End If

        If txtName.Text.Trim = "" Then
            MsgBox("กรุณาป้อนรหัสพนักงานด้วย", MsgBoxStyle.Information, Me.Text)
            txtCode.Focus()
            Exit Sub
        End If


        Try
            If chkDelAll.Checked = False Then
                strSQL = "Delete TimeMaster " & _
                                    " Where Id = '" & lblId.Text.Trim & "'"
                dCmd.Connection = Conn
                dCmd.CommandText = strSQL
                dCmd.ExecuteNonQuery()
            Else
                Dim I As Integer
                With lstTimeEdit
                    For I = 0 To .CheckedItems.Count - 1
                        strSQL = "Delete TimeMaster " & _
                                            " Where Id = '" & .CheckedItems(I).SubItems(1).Text.Trim & "'"
                        dCmd.Connection = Conn
                        dCmd.CommandText = strSQL
                        dCmd.ExecuteNonQuery()
                    Next
                End With
            End If

        Catch ex As Exception
            MsgBox(ex.Message, MsgBoxStyle.Critical, Me.Text)
            Exit Sub
        End Try
        Call GenTimework()
        Call btnClear_Click(Me, System.EventArgs.Empty)
    End Sub

    Private Sub GenTimework()
        Dim DateSt As Date
        Dim DateSp As Date

        DateSt = ConvertDate(txtDate.Text)
        DateSp = ConvertDate(txtDate.Text)

        Dim dCmd As New SqlCommand
        Dim Tn As SqlTransaction
        Dim strSQL As String
        Tn = Conn.BeginTransaction
        dCmd.Transaction = Tn
        Try
            Dim I As Date
            I = DateSt

            strSQL = "Exec spTimeGenTimeWork '" & txtCode.Text.Trim & "'," & _
                                        " '" & Format(I, "yyyy/MM/dd") & "'," & _
                                        " '" & Format(I, "yyyy/MM/dd") & "',1"
            dCmd.Connection = Conn
            dCmd.CommandText = strSQL
            dCmd.ExecuteNonQuery()

            Tn.Commit()
        Catch ex As Exception
            Tn.Rollback()
            MsgBox(ex.Message, MsgBoxStyle.Critical, Me.Text)
            Exit Sub
        End Try
    End Sub

    Private Sub LoadKa(ByVal KaCode As String)
        Dim DA As New SqlDataAdapter
        Dim DS As New DataSet
        Dim strSQL As String
        strSQL = "Select KA_Code,KaName," & _
                            " TimeST,TimeSP," & _
                            " RestST,RestSP,StartDay,EndDay," & _
                            " RestST_ND = Isnull(RestST_ND,0)," & _
                            " RestSP_ND = Isnull(RestSP_ND,0)," & _
                            " TimeSP_ND = Isnull(TimeSP_ND,0)," & _
                            " StartDay_PD = Isnull(StartDay_PD,0)," & _
                            " EndDay_ND = Isnull(EndDay_ND,0)," & _
                            " Monday = Isnull(Monday,0)," & _
                            " Tuesday = Isnull(Tuesday,0)," & _
                            " Wednesday = Isnull(Wednesday,0)," & _
                            " Thursday = Isnull(Thursday,0)," & _
                            " Friday = Isnull(Friday,0)," & _
                            " Saturday = Isnull(Saturday,0)," & _
                            " Sunday = Isnull(Sunday,0) " & _
                " from TimeKa " & _
                " Where KA_Code = '" & KaCode.Trim & "'"
        DA = New SqlDataAdapter(strSQL, Conn)
        DA.Fill(DS, "TimeKa")
        With DS.Tables("TimeKa")
            If .Rows.Count = 0 Then
                Call ClearKaData()
                Exit Sub
            End If
            lblKaCode.Text = KaCode.Trim
            txtTimeST.Text = Format(.Rows(0).Item("TimeST"), "HH:mm")
            txtTimeSP.Text = Format(.Rows(0).Item("TimeSP"), "HH:mm")
            txtMidDayStart.Text = Format(.Rows(0).Item("RestST"), "HH:mm")
            txtMidDayStop.Text = Format(.Rows(0).Item("RestSP"), "HH:mm")
            txtStartDay.Text = Format(.Rows(0).Item("StartDay"), "HH:mm")
            txtEndDay.Text = Format(.Rows(0).Item("EndDay"), "HH:mm")

            If .Rows(0).Item("TimeSP_ND") = True Then
                chkTimeSP_NextDay.Checked = True
            Else
                chkTimeSP_NextDay.Checked = False
            End If

            If .Rows(0).Item("RestST_ND") = True Then
                chkMidDayStart_NextDay.Checked = True
            Else
                chkMidDayStart_NextDay.Checked = False
            End If

            If .Rows(0).Item("RestSP_ND") = True Then
                chkMidDayStop_NextDay.Checked = True
            Else
                chkMidDayStop_NextDay.Checked = False
            End If

            If .Rows(0).Item("StartDay_PD") = True Then
                chkStartDay_PD.Checked = True
            Else
                chkStartDay_PD.Checked = False
            End If

            If .Rows(0).Item("EndDay_ND") = True Then
                chkTimeEndDay_NextDay.Checked = True
            Else
                chkTimeEndDay_NextDay.Checked = False
            End If

            'Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday
            If .Rows(0).Item("Monday") = True Then
                chkMonDay.Checked = True
            Else
                chkMonDay.Checked = False
            End If

            If .Rows(0).Item("Tuesday") = True Then
                chkTuesday.Checked = True
            Else
                chkTuesday.Checked = False
            End If

            If .Rows(0).Item("Wednesday") = True Then
                chkWednesday.Checked = True
            Else
                chkWednesday.Checked = False
            End If

            If .Rows(0).Item("Thursday") = True Then
                chkThursday.Checked = True
            Else
                chkThursday.Checked = False
            End If

            If .Rows(0).Item("Friday") = True Then
                chkFriday.Checked = True
            Else
                chkFriday.Checked = False
            End If

            If .Rows(0).Item("Saturday") = True Then
                chkSaturday.Checked = True
            Else
                chkSaturday.Checked = False
            End If

            If .Rows(0).Item("Sunday") = True Then
                chkSunday.Checked = True
            Else
                chkSunday.Checked = False
            End If
        End With
    End Sub

    Private Sub ClearKaData()
        lblKaCode.Text = ""
        txtTimeST.Text = ""
        txtTimeSP.Text = ""
        txtStartDay.Text = ""
        txtEndDay.Text = ""

        txtMidDayStart.Text = ""
        txtMidDayStop.Text = ""


        chkMidDayStart_NextDay.Checked = False
        chkMidDayStop_NextDay.Checked = False
        chkTimeSP_NextDay.Checked = False
        chkStartDay_PD.Checked = False
        chkTimeEndDay_NextDay.Checked = False


        ' Clear DATE Of Week
        chkMonDay.Checked = False
        chkTuesday.Checked = False
        chkWednesday.Checked = False
        chkThursday.Checked = False
        chkFriday.Checked = False
        chkSaturday.Checked = False
        chkSunday.Checked = False
    End Sub

    Private Sub MaskedTextBox1_MaskInputRejected(ByVal sender As System.Object, ByVal e As System.Windows.Forms.MaskInputRejectedEventArgs) Handles txtStartDay.MaskInputRejected

    End Sub

    Private Sub chkTimeEndDay_NextDay_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkTimeEndDay_NextDay.CheckedChanged

    End Sub


    Function GetKaScope(ByVal KaCode As String, ByVal DateIn As String, ByVal Time_IO As TimeIO) As String
        Dim Da As New SqlDataAdapter
        Dim Ds As New DataSet

        Dim strSQL As String = ""
        Dim Type As String
        Select Case Time_IO
            Case TimeIO.Time_IN
                Type = "I"
            Case Else
                Type = "O"
        End Select
        strSQL = "Select SC_Day = dbo.fGetScopeDay_ByKaCode('" & KaCode.Trim & "','" & DateIn.Trim & "','" & Type.Trim & "')"
        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "data")

        With Ds.Tables("data")
            If .Rows.Count = 0 Then
                Return ""
            Else
                Return .Rows(0).Item("SC_Day")
            End If
        End With
    End Function
End Class