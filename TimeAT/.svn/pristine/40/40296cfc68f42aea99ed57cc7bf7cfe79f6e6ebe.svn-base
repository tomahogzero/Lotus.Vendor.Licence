Imports System.Data
Imports System.Data.SqlClient

Public Class frmEmpCalLate

    Private Sub frmEmpCalLate_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load
        Call LoadDepartment()
        Call LoadCompany()
        If ComId <> "" Then
            cboCompany.Enabled = False
            cboCompany_date.Enabled = False

            cboCompany.SelectedItem = ComName
            cboCompany_date.SelectedItem = ComName
        End If
    End Sub

    Private Sub LoadDepartment()
        Dim Da As SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String = ""
        strSQL = "select Department " & _
                " From Department " & _
                " Order By Department"

        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "data")
        With Ds.Tables("data")
            cboDepartment.Items.Clear()
            cboDepartment.Items.Add("(ทุกแผนก)")

            cboDepartment_Date.Items.Clear()
            cboDepartment_Date.Items.Add("(ทุกแผนก)")
            For Each dr As DataRow In .Rows
                cboDepartment.Items.Add(dr("Department"))
                cboDepartment_Date.Items.Add(dr("Department"))
            Next
            cboDepartment.SelectedIndex = 0
            cboDepartment_Date.SelectedIndex = 0
        End With
    End Sub

    Private Sub LoadEmp()
        Dim Da As SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String = ""
        Dim arrData() As String
        Dim List As ListViewItem

        strSQL = "select Code,Fname,Lname, " & _
                        " Department = Isnull(Department.Department,'') " & _
                " From Emp Left Join Department " & _
                        " On Emp.DeptId = Department.DeptId " & _
                             " Left Join Company_sub cs" & _
                        " on Emp.CompanyID = cs.CompanyID " & _
                " Where WorkStatus = 'W' and CalLate = 0 "

        If cboCompany.SelectedIndex > 0 Then
            strSQL &= " and isnull(Emp.CompanyId,'') = '" & GetData.GetCompanyId(cboCompany.Text.Trim) & "'"
        End If

        If cboDepartment.SelectedIndex > 0 Then
            strSQL &= " and Isnull(Department.Department,'') = '" & cboDepartment.Text.Trim & "'"
        End If

        If txtNameSearch.Text.Trim <> "" Then
            strSQL &= " and (Fname + LName) Like '%" & Replace(txtNameSearch.Text.Trim, " ", "") & "%'"
        End If


        If rdByCode.Checked = True Then
            strSQL &= " Order By Code"
        End If

        If rdByName.Checked = True Then
            strSQL &= " Order By Fname,Lname"
        End If

        If rdByDeptCode.Checked = True Then
            strSQL &= " Order By Department.Department,Code"
        End If

        If rdByDeptName.Checked = True Then
            strSQL &= " Order By Department.Department,Fname,Lname"
        End If

        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "data")
        With Ds.Tables("data")
            'lstEmp.BeginUpdate()
            If .Rows.Count = 0 Then
                lstEmp.Items.Clear()
            Else
                lstEmp.Items.Clear()

                Dim I As Integer = 0
                ProgressBar1.Value = 0
                ProgressBar1.Maximum = .Rows.Count
                For Each dr As DataRow In .Rows
                    I += 1
                    ProgressBar1.Text = Format((I * 100) / ProgressBar1.Maximum, "#0.00") & "%"
                    ProgressBar1.Value = I

                    arrData = New String() {lstEmp.Items.Count + 1, _
                                            dr("Code"), _
                                            dr("Fname"), _
                                            dr("LName"), _
                                            dr("Department")}
                    List = New ListViewItem(arrData)
                    lstEmp.Items.Add(List)
                Next
            End If
            'lstEmp.EndUpdate()
        End With
    End Sub

    Private Sub LoadEmpKaDate()
        Dim Da As SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String = ""
        Dim arrData() As String
        Dim List As ListViewItem

        strSQL = "select Code,Fname,Lname, " & _
                        " Department = Isnull(Department.Department,'') " & _
                " From Emp Left Join Department " & _
                        " On Emp.DeptId = Department.DeptId " & _
                             " Left Join Company_sub cs" & _
                        " on Emp.CompanyID = cs.CompanyID " & _
                " Where WorkStatus = 'W' and CalLate = 1"

        If cboCompany.SelectedIndex > 0 Then
            strSQL &= " and isnull(Emp.CompanyId,'') = '" & GetData.GetCompanyId(cboCompany.Text.Trim) & "'"
        End If

        If cboDepartment_Date.SelectedIndex > 0 Then
            strSQL &= " and Isnull(Department.Department,'') = '" & cboDepartment_Date.Text.Trim & "'"
        End If

        If txtNameSearch_Date.Text.Trim <> "" Then
            strSQL &= " and (Fname + LName) Like '%" & Replace(txtNameSearch_Date.Text.Trim, " ", "") & "%'"
        End If

        If rdByCode_Date.Checked = True Then
            strSQL &= " Order By Code"
        End If

        If rdByName_Date.Checked = True Then
            strSQL &= " Order By Fname,Lname"
        End If

        If rdByDeptCode_Date.Checked = True Then
            strSQL &= " Order By Department.Department,Code"
        End If

        If rdByDeptName_Date.Checked = True Then
            strSQL &= " Order By Department.Department,Fname,Lname"
        End If

        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "data")
        With Ds.Tables("data")
            'lstEmp.BeginUpdate()
            If .Rows.Count = 0 Then
                lstEmp_Date.Items.Clear()
            Else
                lstEmp_Date.Items.Clear()
                Dim I As Integer = 0
                ProgressBar1.Value = 0
                ProgressBar1.Maximum = .Rows.Count
                For Each dr As DataRow In .Rows
                    I += 1
                    ProgressBar1.Text = Format((I * 100) / ProgressBar1.Maximum, "#0.00") & "%"
                    ProgressBar1.Value = I
                    arrData = New String() {lstEmp_Date.Items.Count + 1, _
                                            dr("Code"), _
                                            dr("Fname"), _
                                            dr("LName"), _
                                            dr("Department")}
                    List = New ListViewItem(arrData)
                    lstEmp_Date.Items.Add(List)
                Next
            End If
            'lstEmp.EndUpdate()
        End With
    End Sub

    Private Sub btnRefresh_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnRefresh.Click
        Call LoadEmp()
    End Sub

    Private Sub btnRefresh_Date_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnRefresh_Date.Click
        Call LoadEmpKaDate()
    End Sub

    Private Sub btnSelectAll_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSelectAll.Click
        With lstEmp
            For i As Integer = 0 To .Items.Count - 1
                .Items(i).Checked = True
            Next
        End With
    End Sub

    Private Sub btnNoneSelectAll_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnNoneSelectAll.Click
        With lstEmp
            For i As Integer = 0 To .Items.Count - 1
                .Items(i).Checked = False
            Next
        End With
    End Sub

    Private Sub btnNoneSelectAll_Date_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnNoneSelectAll_Date.Click
        With lstEmp_Date
            For i As Integer = 0 To .Items.Count - 1
                .Items(i).Checked = False
            Next
        End With
    End Sub

    Private Sub btnSelectAll_Date_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnSelectAll_Date.Click
        With lstEmp_Date
            For i As Integer = 0 To .Items.Count - 1
                .Items(i).Checked = True
            Next
        End With
    End Sub

    Private Sub btnAdd_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnAdd.Click
        If lstEmp.CheckedItems.Count = 0 Then Exit Sub
        btnAdd.Enabled = False

        Dim dCmd As New SqlCommand
        Dim strSQL As String
        Dim Tn As SqlTransaction

        Tn = Conn.BeginTransaction
        dCmd.Transaction = Tn
        Try
            ProgressBar1.Value = 0
            ProgressBar1.Maximum = lstEmp.CheckedItems.Count
            For i As Integer = 0 To lstEmp.CheckedItems.Count - 1
                ProgressBar1.Value = i + 1
                ProgressBar1.Text = Format((i * 100) / ProgressBar1.Maximum, "#0.00") & "%"
                Application.DoEvents()

                strSQL = "Update Emp Set CalLate = 1 " & _
                        " Where Code = '" & lstEmp.CheckedItems(i).SubItems(1).Text.Trim & "'"
                dCmd.Connection = Conn
                dCmd.CommandText = strSQL
                dCmd.ExecuteNonQuery()
            Next
            Tn.Commit()
        Catch ex As Exception
            btnAdd.Enabled = True
            Tn.Rollback()
            MsgBox(ex.Message, MsgBoxStyle.Information, Me.Text)
            Exit Sub
        End Try
        btnAdd.Enabled = True
        Call btnRefresh_Click(Me, System.EventArgs.Empty)
        Call btnRefresh_Date_Click(Me, System.EventArgs.Empty)
    End Sub

    Private Sub btnRemove_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnRemove.Click
        If lstEmp_Date.CheckedItems.Count = 0 Then Exit Sub
        btnRemove.Enabled = False

        Dim dCmd As New SqlCommand
        Dim strSQL As String
        Dim Tn As SqlTransaction

        Tn = Conn.BeginTransaction
        dCmd.Transaction = Tn
        Try
            ProgressBar1.Value = 0
            ProgressBar1.Maximum = lstEmp_Date.CheckedItems.Count
            For i As Integer = 0 To lstEmp_Date.CheckedItems.Count - 1
                ProgressBar1.Value = i + 1
                ProgressBar1.Text = Format((i * 100) / ProgressBar1.Maximum, "#0.00") & "%"
                Application.DoEvents()

                strSQL = "Update Emp Set CalLate = 0 " & _
                        " Where Code = '" & lstEmp_Date.CheckedItems(i).SubItems(1).Text.Trim & "'"
                dCmd.Connection = Conn
                dCmd.CommandText = strSQL
                dCmd.ExecuteNonQuery()
            Next
            Tn.Commit()
        Catch ex As Exception
            btnRemove.Enabled = True
            Tn.Rollback()
            MsgBox(ex.Message, MsgBoxStyle.Information, Me.Text)
            Exit Sub
        End Try
        btnRemove.Enabled = True
        Call btnRefresh_Click(Me, System.EventArgs.Empty)
        Call btnRefresh_Date_Click(Me, System.EventArgs.Empty)
    End Sub

    Private Sub btnExit_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnExit.Click
        Me.Close()
    End Sub

    Private Sub LoadCompany()
        Dim Da As New SqlDataAdapter
        Dim Ds As New DataSet
        Dim strSQL As String
        strSQL = "Select CompanyName From Company_Sub "
        Da = New SqlDataAdapter(strSQL, Conn)
        Da.Fill(Ds, "Data")
        With Ds.Tables("Data")
            cboCompany.Items.Clear()
            cboCompany.Items.Add("ทั้งหมด")

            cboCompany_date.Items.Clear()
            cboCompany_date.Items.Add("ทั้งหมด")
            Dim I As Integer
            For I = 0 To .Rows.Count - 1
                cboCompany.Items.Add(.Rows(I).Item("CompanyName"))

                cboCompany_date.Items.Add(.Rows(I).Item("CompanyName"))
            Next
            Ds.Clear()
            cboCompany.SelectedIndex = 0
        End With
    End Sub

End Class